<!-- e01ea919-5821-4882-a95f-6f9467513d01 9e8d3e1d-63b8-49b7-bfe2-814562b8e0b4 -->
# Safeguard incident → Claim (auto-ingest)

### Context (existing code to leverage)

```73:88:server/services/safetyMonitorService.js
    async findTodayEmails(auth) {
        const gmail = google.gmail({ version: 'v1', auth });
        const senderFilter = process.env.GMAIL_SENDER_FILTER || '@safeguardapps.com';
        const subjectFilter = '(subject:("מדד בטיחות" OR "חריגים יומי" OR "חריגי עובדים" OR "חריגי ציוד"))';
        const labelFilter = process.env.GMAIL_LABEL ? `label:${process.env.GMAIL_LABEL}` : null;
        const baseQuery = [
            `from:${senderFilter}`,'has:attachment','newer_than:7d',subjectFilter,labelFilter
        ].filter(Boolean).join(' ');
```



```1:22:server/routes/claims.js
const express = require('express');
const router = express.Router();
const { getDb } = require('../lib/mongo');
// Route to create a new claim
router.post('/', async (req, res) => {
```



```252:289:src/components/ClaimFormPage.tsx
interface ClaimFormData {
    projectId: string; projectName: string; eventDate: string; eventTime: string;
    eventLocation: string; eventAddress: string; description: string;
    propertyDamageInsured: boolean | null; propertyDamageThirdParty: boolean | null;
    bodilyInjuryThirdParty: boolean | null; bodilyInjuryEmployee: boolean | null;
    hasWitnesses: boolean; witnesses: Witness[]; status: string; /* ... */
    createdAt: Date; updatedAt: Date;
}
```

Reference incident example to parse: [Safeguard report (Hebrew)](https://www.safeguardapps.com/storage/servlet/Image?c=352484338&token=1418704381-450642468-450642453).

---

### Backend changes

- Update Gmail search to include incident subjects (Hebrew): "דוח אירועי בטיחות", "תאונה", "בוצע דיווח חקיר". Allow overriding via `GMAIL_INCIDENT_SUBJECTS`.
- In `fetchAndProcessReports`, add an incident path: when subject matches incident keywords, extract the attachment/link, download PDF, and parse.
- Implement `parseAccidentReportFromPdf(buffer)` to return:
  - `siteName`, `eventDate` (dd/mm/yyyy), `eventTime` (hh:mm), `summary`, `severity`, `eventLocation`, `contractorName`, plus `rawText`.
  - Parse by matching Hebrew labels found in the PDF: "שם האתר", "תאריך ושעה", "תמצית", "חומרה", "מיקום האירוע".
- Project matching: reuse existing `extractProjectName(subject)`; if not found, fallback to PDF `siteName`. Lookup `projects` by normalized name.
- Deduplication: before creating, search `claims` by `projectId` where `eventDate` within ±3 days and `description`/`summary` similarity (simple substring) to avoid duplicates. If found, append the new evidence and skip new record.
- Claim creation (DB insert, not HTTP):
  - Create a minimal `ClaimFormData`-compatible record with: `status: 'open'`, `projectId`, `projectName`, `eventDate`, `eventTime`, `eventLocation`, `description: summary`, `bodilyInjuryEmployee: null`, `bodilyInjuryThirdParty: null`, `propertyDamageInsured: null`, `propertyDamageThirdParty: null`, `generalAttachments: [{ documentType: 'safeguard-incident', documentDescription: severity, fileUrl: reportLink } ]`, timestamps, and a `source` object `{ vendor: 'Safeguard', gmailMessageId, severity, reportLink, rawText }`.
  - After insert, also push the claim id to `projects.claimsIdArray` (same semantics as existing create route).
- Idempotency: store `source.vendor='Safeguard'` + `gmailMessageId` on the claim; on subsequent runs, skip if same `gmailMessageId` already attached.

### Config & docs

- Add env var `GMAIL_INCIDENT_SUBJECTS` (comma-separated) and document it in `SAFETY_MONITOR_GUIDE.md`.
- Optional: `GMAIL_LABEL` can scope queries to a Gmail label like "Safeguard".

### Observability

- Log creates/updates with project/site name, event date/time, claim id.

### UI

- No change required; new claims will appear under the project's "תביעות" tab via `GET /api/claims/project/:projectId`.
- Future nicety: surface `severity` badge and a quick link to the Safeguard PDF inside the claim view.

### Acceptance criteria

- Given the Ramat Hasharon 27+28 incident email, system creates (or merges into) one claim linked to that project with status `open` and attachment to the Safeguard report.
- Re-running the job does not duplicate the claim.
- Incident emails in the last 7 days are ingested automatically by the cron.

### To-dos

- [ ] Add incident keywords and env var to Gmail search in safety monitor
- [ ] Branch incident handling in fetchAndProcessReports and pull PDF/link
- [ ] Implement parseAccidentReportFromPdf to extract key Hebrew fields
- [ ] Resolve project by subject or PDF site name; handle normalization
- [ ] Check existing claims by project + ±3d eventDate; merge if exists
- [ ] Insert claim with status open and Safeguard source metadata
- [ ] Append claim id to project.claimsIdArray
- [ ] Avoid duplicates by gmailMessageId attachment/source check
- [ ] Add one-off script to run ingestion now for verification
- [ ] Update SAFETY_MONITOR_GUIDE with new env var and flow