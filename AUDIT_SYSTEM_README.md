# מערכת Audit Event-Driven

## סקירה כללית

מערכת ה-Audit Event-Driven מספקת מעקב מקיף אחר כל הפעולות במערכת, כולל:
- מי נכנס למערכת ומתי
- מאיזה מכשיר ומאיזה IP
- מה המשתמש ראה, שינה או מחק
- כל הפעולות מתעדות בצורה מקוננת לפי timestamp במונגו אטלס

## רכיבי המערכת

### 1. מודל AuditEvent (`/server/models/AuditEvent.js`)
- מבנה מקונן עם מידע מפורט על כל אירוע
- אינדקסים מותאמים לביצועים
- TTL אוטומטי לניקוי נתונים ישנים (2 שנים)
- פונקציות סטטיות לניתוח נתונים

### 2. שירות AuditService (`/server/services/auditService.js`)
- ניהול אירועי audit
- זיהוי דפוסים חשודים
- חישוב רמות סיכון
- API לניתוח נתונים

### 3. Middleware (`/server/middleware/auditMiddleware.js`)
- זיהוי אוטומטי של פעולות משתמש
- חילוץ מידע על מכשיר ומיקום
- מעקב אחר פעולות API

### 4. Event Emitter (`/server/services/eventEmitter.js`)
- פרסום אירועים בזמן אמת
- זיהוי דפוסים חשודים
- התראות אבטחה

### 5. API Endpoints (`/server/routes/audit.js`)
- `/api/audit/events` - קבלת אירועי audit
- `/api/audit/statistics` - סטטיסטיקות
- `/api/audit/events/realtime` - אירועים בזמן אמת
- `/api/audit/events/export` - ייצוא נתונים

### 6. ממשק משתמש (`/src/pages/AuditDashboard.tsx`)
- לוח בקרה מקיף
- סינון וניתוח נתונים
- מעקב בזמן אמת
- ייצוא נתונים

## סוגי אירועים

### פעולות משתמש
- `login` - התחברות
- `logout` - התנתקות
- `view` - צפייה בנתונים
- `create` - יצירת רשומות
- `update` - עדכון רשומות
- `delete` - מחיקת רשומות
- `search` - חיפוש
- `export` - ייצוא נתונים
- `import` - ייבוא נתונים

### משאבים
- `contractor` - קבלנים
- `user` - משתמשים
- `project` - פרויקטים
- `file` - קבצים
- `system` - מערכת

### רמות סיכון
- `low` - נמוכה
- `medium` - בינונית
- `high` - גבוהה
- `critical` - קריטית

## תכונות אבטחה

### זיהוי דפוסים חשודים
- פעילות מהירה (יותר מ-10 פעולות בדקה)
- IP חשוד (יותר מ-50 פעולות בשעה)
- התחברות ממכשירים/מיקומים חדשים
- פעולות bulk (מחיקה/עדכון של רשומות רבות)

### התראות אבטחה
- התראות בזמן אמת
- לוגים מפורטים
- מעקב אחר פעילות חשודה

## שימוש

### גישה ללוח הבקרה
1. התחבר כמשתמש admin
2. לחץ על תפריט המשתמש (אבטר)
3. בחר "לוח בקרת פעילות"

### סינון נתונים
- תאריך
- סוג פעולה
- משאב
- רמת סיכון
- מזהה משתמש

### מעקב בזמן אמת
- הפעל "התחל מעקב" לראות אירועים בזמן אמת
- אירועים חדשים יופיעו אוטומטית

### ייצוא נתונים
- לחץ על "ייצא נתונים" ליצירת קובץ CSV
- הנתונים כוללים את כל המידע הרלוונטי

## הגדרות

### משתני סביבה
```bash
# אין משתני סביבה נדרשים - המערכת משתמשת בהגדרות הקיימות
```

### הרשאות
- רק משתמשי admin יכולים לגשת ללוח הבקרה
- כל המשתמשים מנוטרים אוטומטית

## תחזוקה

### ניקוי נתונים
- המערכת מנקה אוטומטית נתונים ישנים מ-2 שנים
- ניתן לשנות את ה-TTL במודל AuditEvent

### ביצועים
- אינדקסים מותאמים לביצועים
- אגרגציה יעילה לניתוח נתונים
- דחיסת נתונים ישנים

## עתיד

המערכת תומכת בתכונות עתידיות:
- Undo operations
- History tracking
- Full audit trail
- Advanced analytics
- Machine learning for anomaly detection

## פתרון בעיות

### בעיות נפוצות
1. **אירועים לא מופיעים** - בדוק שהמשתמש מחובר
2. **ביצועים איטיים** - בדוק אינדקסים במונגו
3. **זיכרון גבוה** - בדוק את ה-TTL של האירועים

### לוגים
- כל השגיאות נרשמות בקונסול
- ניתן לעקוב אחר האירועים בלוגים

## תמיכה

לשאלות או בעיות, פנה למפתח המערכת.