require('dotenv').config();
const { getDb } = require('../server/lib/mongo');

async function fixAttachmentDatesAndFlags() {
    try {
        console.log('ğŸ”— Connecting to database...');
        const db = await getDb();
        const projectId = '68bd7488690387dac0eb69c0';

        // Get the current claim
        console.log('ğŸ” Getting current claim...');
        const claim = await db.collection('claims').findOne({ projectId });
        if (!claim) {
            console.log('âŒ No claim found for project');
            return;
        }

        console.log('ğŸ“‹ Current attachments:', claim.generalAttachments?.length || 0);

        // Convert DD/MM/YYYY to YYYY-MM-DD for HTML date input
        const convertDate = (dateStr) => {
            if (!dateStr) return '';
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                return `${year}-${month}-${day}`;
            }
            return dateStr;
        };

        // Update attachments with proper date format and isAuto flag
        const updatedAttachments = claim.generalAttachments?.map((attachment) => {
            return {
                ...attachment,
                validUntil: convertDate(attachment.validUntil || ''),
                isAutoGenerated: true // Mark as auto-generated to hide delete button
            };
        }) || [];

        console.log('ğŸ”§ Updated attachment details:');
        updatedAttachments.forEach((att, index) => {
            console.log(`  Attachment ${index + 1}:`);
            console.log(`    - Valid Until: ${att.validUntil}`);
            console.log(`    - Is Auto Generated: ${att.isAutoGenerated}`);
        });

        // Update the claim
        console.log('ğŸ’¾ Updating claim with fixed attachments...');
        const result = await db.collection('claims').updateOne(
            { _id: claim._id },
            {
                $set: {
                    generalAttachments: updatedAttachments,
                    updatedAt: new Date()
                }
            }
        );

        console.log('âœ… Updated claim:', result.modifiedCount, 'documents');

        console.log('ğŸ‰ Attachments updated with proper dates and auto-generated flag!');

    } catch (e) {
        console.error('âŒ Error:', e.message);
        console.error(e.stack);
    } finally {
        process.exit(0);
    }
}

fixAttachmentDatesAndFlags();



