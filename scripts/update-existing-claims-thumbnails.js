require('dotenv').config();
const { getDb } = require('../server/lib/mongo');

async function updateExistingClaimsWithThumbnails() {
    try {
        console.log('ğŸ”— Connecting to database...');
        const db = await getDb();
        const projectId = '68bd7488690387dac0eb69c0';

        // Get the current claim
        console.log('ğŸ” Getting current claim...');
        const claim = await db.collection('claims').findOne({ projectId });
        if (!claim) {
            console.log('âŒ No claim found for project');
            return;
        }

        console.log('ğŸ“‹ Current attachments:', claim.generalAttachments?.length || 0);

        // Generate thumbnails for each attachment
        const updatedAttachments = [];
        for (const attachment of claim.generalAttachments || []) {
            if (attachment.isAutoGenerated && attachment.fileUrl) {
                console.log(`ğŸ–¼ï¸ Generating thumbnail for attachment: ${attachment.id}`);

                try {
                    // Call the PDF thumbnail API endpoint
                    const baseUrl = process.env.BASE_URL || 'http://localhost:3000';
                    const response = await fetch(`${baseUrl}/api/pdf-thumbnail`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            pdfUrl: attachment.fileUrl,
                            _targetWidth: 400 // Thumbnail width
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const thumbnailUrl = result.url || '';
                        if (thumbnailUrl) {
                            console.log(`âœ… Thumbnail generated: ${thumbnailUrl}`);
                            updatedAttachments.push({
                                ...attachment,
                                thumbnailUrl: thumbnailUrl
                            });
                        } else {
                            console.warn(`âš ï¸ No thumbnail URL returned for ${attachment.id}`);
                            updatedAttachments.push(attachment);
                        }
                    } else {
                        console.warn(`âš ï¸ Failed to generate thumbnail for ${attachment.id}: ${response.statusText}`);
                        updatedAttachments.push(attachment);
                    }
                } catch (e) {
                    console.error(`âŒ Error generating thumbnail for ${attachment.id}:`, e.message);
                    updatedAttachments.push(attachment);
                }
            } else {
                updatedAttachments.push(attachment);
            }
        }

        // Update the claim
        console.log('ğŸ’¾ Updating claim with PDF thumbnails...');
        const result = await db.collection('claims').updateOne(
            { _id: claim._id },
            {
                $set: {
                    generalAttachments: updatedAttachments,
                    updatedAt: new Date()
                }
            }
        );

        console.log('âœ… Updated claim:', result.modifiedCount, 'documents');

        console.log('ğŸ‰ PDF thumbnails updated successfully!');

    } catch (e) {
        console.error('âŒ Error:', e.message);
        console.error(e.stack);
    } finally {
        process.exit(0);
    }
}

updateExistingClaimsWithThumbnails();


